<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <link rel="stylesheet" href="/styles.css" />
    <title>Library | Home</title>
  </head>
  <body>
    <div class="grid-container">
      <nav>
        <div id="welcome">
          <a href="/" class="course"
            ><h1>Backend och databaser</h1></a
          >
          <p class="student">
            Laboration 1 - Kristina Palmquist - JSU22
          </p>
        </div>
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/register">Register</a></li>
          <li><a href="/search">Search</a></li>
          <li><a href="/chat">Chat</a></li>
        </ul>
      </nav>

      <main>
        <div class="content">
          <h1>ITHS Backend Library</h1>
          <h2>All titles</h2>
          <table id="titles">
            <tr>
              <th>Book ID</th>
              <th>Title</th>
              <th>Author</th>
              <th>Year published</th>
              <th>Genre</th>
              <th>Total quantity</th>
              <th>Available quantity</th>
              <th>Loaned quantity</th>
              <th>Actions</th>
            </tr>
          </table>
        </div>
      </main>

      <footer>
        <p>Copyright &copy; Kristina Palmquist 2023</p>
      </footer>
    </div>

    <script>
      // GET-request
      const options = {
        method: "GET",
        headers: {
          Accept: "application/json",
        },
      };

      // call printCustomerData
      printTitleData();

      async function printTitleData() {
        try {
          // Clear existing table rows (except header)
          let table = document.querySelector("#titles");
          const rows = table.querySelectorAll(
            "tr:not(:first-child)"
          );
          rows.forEach((row) => row.remove());

          // call getTitles, receive data
          let data = await getTitles();
          console.log("Fetched data:", data); // Debug log
          
          if (!data || data.length === 0) {
            console.log("No data received or empty array");
            return;
          }

          // print data
          for (const title of data) {
            // create a row in the table for each book and render details
            let element = document.createElement("tr");
            element.innerHTML += `<td>${title.title.titleId}</td>
                      <td>${title.title.titleBook}</td><td>${title.title.authorName}</td>
                      <td>${title.title.publYear}</td><td>${title.title.genre}</td>
                      <td>${title.title.totalQuantity}</td>
                      <td>${title.title.availableQuantity}/${title.title.totalQuantity}</td>
                      <td>${title.title.loanedQuantity}/${title.title.totalQuantity}</td>
                      <td class="actions">
                        <button class="btn btn-loan" onclick="loanBook(${title.title.titleId}, '${title.title.titleBook}')">Loan</button>
                        <button class="btn btn-edit" onclick="editBook(${title.title.titleId}, '${title.title.titleBook}', '${title.title.authorName}', ${title.title.publYear}, '${title.title.genre}')">Edit</button>
                        <button class="btn btn-delete" onclick="deleteBook(${title.title.titleId}, '${title.title.titleBook}')">Delete</button>
                      </td>`;
            table.appendChild(element);
          }
        } catch (error) {
          console.error("Error in printTitleData:", error);
        }
      }

      // Function to refresh table data without full page reload
      async function refreshTableData() {
        await printTitleData();
      }

      // collect data
      async function getTitles() {
        try {
          // call API and await response
          const response = await fetch(
            "http://localhost:5421/title/all",
            options
          );
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          // make response into json
          let data = await response.json();
          // return the data
          return data;
        } catch (error) {
          console.error("Error fetching titles:", error);
          alert("Error loading books. Please refresh the page.");
          return []; // Return empty array to prevent further errors
        }
      }

      // Function to handle book loan
      async function loanBook(titleId, titleBook) {
        // First, get current book data to calculate correct quantities
        try {
          const currentData = await getTitles();
          const currentBook = currentData.find(
            (book) => book.title.titleId === titleId
          );

          if (!currentBook) {
            alert("Book not found.");
            return;
          }

          const currentAvailable =
            currentBook.title.availableQuantity;
          const currentLoaned =
            currentBook.title.loanedQuantity;
          const totalQuantity =
            currentBook.title.totalQuantity;

          if (currentAvailable <= 0) {
            alert(
              `No copies of "${titleBook}" are available for loan.`
            );
            return;
          }

          const toLoan = prompt(
            `How many copies of "${titleBook}" do you want to loan? (Available: ${currentAvailable})`
          );
          if (toLoan === null) return; // User cancelled

          const toLoanNum = parseInt(toLoan);
          if (isNaN(toLoanNum) || toLoanNum <= 0) {
            alert(
              "Please enter a valid number of copies to loan."
            );
            return;
          }

          if (toLoanNum > currentAvailable) {
            alert(
              `Only ${currentAvailable} copies are available.`
            );
            return;
          }

          // Calculate new quantities
          const newAvailable = currentAvailable - toLoanNum;
          const newLoaned = currentLoaned + toLoanNum;

          const response = await fetch(
            "http://localhost:5421/title/loan",
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                titleId: titleId,
                availableQuantity: newAvailable,
                loanedQuantity: newLoaned,
              }),
            }
          );

          if (response.ok) {
            alert(
              `Successfully loaned ${toLoanNum} copies of "${titleBook}"`
            );
            await refreshTableData(); // Refresh the table data
          } else {
            alert("Error loaning book. Please try again.");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error loaning book. Please try again.");
        }
      }

      // Function to handle book edit
      function editBook(
        titleId,
        titleBook,
        authorName,
        publYear,
        genre
      ) {
        const newTitle = prompt("Book Title:", titleBook);
        if (newTitle === null) return; // User cancelled

        const newAuthor = prompt(
          "Author Name:",
          authorName
        );
        if (newAuthor === null) return;

        const newYear = prompt(
          "Publication Year:",
          publYear
        );
        if (newYear === null) return;

        const newGenre = prompt("Genre:", genre);
        if (newGenre === null) return;

        const yearNum = parseInt(newYear);
        if (isNaN(yearNum)) {
          alert("Please enter a valid year.");
          return;
        }

        updateBook(
          titleId,
          newTitle,
          newAuthor,
          yearNum,
          newGenre
        );
      }

      // Function to update book
      async function updateBook(
        titleId,
        titleBook,
        authorName,
        publYear,
        genre
      ) {
        try {
          const response = await fetch(
            "http://localhost:5421/title/edit",
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                titleId: titleId,
                titleBook: titleBook,
                authorName: authorName,
                publYear: publYear,
                genre: genre,
              }),
            }
          );

          if (response.ok) {
            alert(`Successfully updated "${titleBook}"`);
            await refreshTableData(); // Refresh the table data
          } else {
            alert("Error updating book. Please try again.");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error updating book. Please try again.");
        }
      }

      // Function to handle book deletion
      async function deleteBook(titleId, titleBook) {
        const confirmed = confirm(
          `Are you sure you want to delete "${titleBook}"?`
        );
        if (!confirmed) return;

        try {
          const response = await fetch(
            "http://localhost:5421/title/remove",
            {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                titleId: titleId,
              }),
            }
          );

          if (response.ok) {
            alert(`Successfully deleted "${titleBook}"`);
            await refreshTableData(); // Refresh the table data
          } else {
            alert("Error deleting book. Please try again.");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error deleting book. Please try again.");
        }
      }
    </script>
  </body>
</html>
